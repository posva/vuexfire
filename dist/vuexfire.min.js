/**
 * vuexfire v3.0.0-alpha.4
 * (c) 2018 Eduardo San Martin Morote <posva13@gmail.com>
 * @license MIT
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.Vuexfire={})}(this,function(e){"use strict";function I(e){return Object.defineProperty(e.data(),"id",{value:e.id})}var a=function(e){return e&&"object"==typeof e},c=function(e){return e.toDate},u=function(e){return e&&e.onSnapshot};function m(r,o,i,e){void 0===i&&(i=""),void 0===e&&(e=[{},{}]),o=o||{};var t=Object.getOwnPropertyDescriptor(r,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(r).reduce(function(e,t){var n=r[t];return u(n)?(e[0][t]=o[t]||n.path,e[1][i+t]=n):Array.isArray(n)?(e[0][t]=Array(n.length).fill(null),m(n,o[t],i+t+".",[e[0][t],e[1]])):null==n||n instanceof Date||c(n)||n.longitude&&n.latitude?e[0][t]=n:a(n)?(e[0][t]={},m(n,o[t],i+t+".",[e[0][t],e[1]])):e[0][t]=n,e},e)}function h(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}var t,w="vuexfire/SET_VALUE",b="vuexfire/ARRAY_ADD",g="vuexfire/ARRAY_REMOVE",r=((t={})[w]=function(e,t){var n,r,o,i,a,c=t.path,u=t.target,f=t.data;n=u,r=f,o=(""+c).split("."),i=o.pop(),a=o.reduce(function(e,t){return e[t]},n),isFinite(i)?a.splice(i,1,r):a[i]=r},t[b]=function(e,t){var n=t.newIndex,r=t.data;t.target.splice(n,0,r)},t[g]=function(e,t){var n=t.oldIndex;return t.target.splice(n,1)[0]},t),o={},E={root:!0};function R(e){for(var t in e)e[t].unsub()}function y(e,v){var m=e.subs,h=e.refs,b=e.target,g=e.path,y=(e.data,e.depth),x=e.commit,j=e.resolve,t=Object.keys(h);if(Object.keys(m).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){m[e].unsub(),delete m[e]}),!t.length||++y>v.maxRefDepth)return j(g);var O=0,k=t.length,A=Object.create(null);t.forEach(function(e){var t,n,r,o,i,a,c,u,f,s,d=m[e],l=h[e],p=g+"."+e;if(A[p]=!0,d){if(d.path===l.path)return;d.unsub()}m[e]={unsub:(t={ref:l,target:b,path:p,depth:y,commit:x,resolve:function(e){e in A&&++O>=k&&j(g)}.bind(null,p)},n=v,r=t.ref,o=t.target,i=t.path,a=t.depth,c=t.commit,u=t.resolve,f=Object.create(null),s=r.onSnapshot(function(e){e.exists?D({snapshot:I(e),target:o,path:i,subs:f,depth:a,commit:c,resolve:u},n):(c(w,{target:o,path:i,data:null},E),u(i))}),function(){s(),R(f)}),path:l.path}})}function D(e,t){var n=e.snapshot,r=e.target,o=e.path,i=e.subs,a=e.depth;void 0===a&&(a=0);var c=e.commit,u=e.resolve,f=m(n,h(r,o)),s=f[0],d=f[1];c(w,{path:o,target:r,data:s},E),y({data:s,subs:i,refs:d,target:r,path:o,depth:a,commit:c,resolve:u},t)}Object.keys(r).forEach(function(n){o[n]=function(e,t){r[n](t.state,t)}});var f=new WeakMap;function i(e,n){var r=e.state,o=e.commit,i=e.key,a=e.ref;void 0===n&&(n={maxRefDepth:2});var c=f.get(o);return c||(c=Object.create(null),f.set(o,c)),i in c&&s({commit:o,key:i}),new Promise(function(e,t){c[i]=a.where?function(e,f){var i=e.vm,a=e.key,t=e.collection,s=e.commit,d=e.resolve,n=e.reject;s(w,{path:a,target:i,data:[]},E);var c,l=h(i,a),u=d,p=[],v={added:function(e){var t=e.newIndex,n=e.doc;p.splice(t,0,Object.create(null));var r=p[t],o=m(I(n)),i=o[0],a=o[1];s(b,{target:l,newIndex:t,data:i},E),y({data:i,refs:a,subs:r,target:l,path:t,depth:0,commit:s,resolve:d.bind(null,n)},f)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,o=p.splice(t,1)[0];p.splice(n,0,o);var i=s(g,{target:l,oldIndex:t},E),a=m(I(r),i),c=a[0],u=a[1];s(b,{target:l,newIndex:n,data:c},E),y({data:c,refs:u,subs:o,target:l,path:n,depth:0,commit:s,resolve:d},f)},removed:function(e){var t=e.oldIndex;s(g,{target:l,oldIndex:t},E),R(p.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t=e.docChanges;if(!c&&t.length){c=!0;var n=0,r=t.length,o=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in o&&++n>=r&&(u(i[a]),d=function(e){})}}t.forEach(function(e){v[e.type](e)}),t.length||d()},n);return function(){r(),p.forEach(R)}}({vm:r,key:i,collection:a,commit:o,resolve:e,reject:t},n):function(e,t){var n,r,o,i=e.vm,a=e.key,c=e.document,u=e.commit,f=e.resolve,s=e.reject,d=Object.create(null);n=f,r=function(){return i[a]},f=function(){if(!o)return o=!0,n(r())};var l=c.onSnapshot(function(e){e.exists?D({snapshot:I(e),target:i,path:a,subs:d,commit:u,resolve:f},t):f()},s);return function(){l(),R(d)}}({vm:r,key:i,document:a,commit:o,resolve:e,reject:t},n)})}function s(e){var t=e.commit,n=e.key,r=f.get(t);r&&"function"==typeof r&&(r[n](),delete r[n])}e.firebaseMutations=o,e.firebaseAction=function(n){return function(e,t){var r=e.state,o=e.commit;return e.bindFirebaseRef=function(e,t,n){return void 0===n&&(n={}),i({state:r,commit:o,key:e,ref:t},n)},e.unbindFirebaseRef=function(e){return s({commit:o,key:e})},n(e,t)}},Object.defineProperty(e,"__esModule",{value:!0})});